<!DOCTYPE html>

<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

```
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif;
        background: #f5f4ef;
        min-height: 100vh;
        color: #2d2d2d;
    }
    
    .container { max-width: 1200px; margin: 0 auto; padding: 12px; }
    
    .header {
        text-align: center;
        padding: 20px 0 15px;
        border-bottom: 1px solid #e5e3dc;
        margin-bottom: 15px;
    }
    .header h1 { font-size: 22px; color: #c96442; margin-bottom: 4px; }
    .header .subtitle { color: #6b6b6b; font-size: 13px; }
    
    .db-switcher { display: flex; justify-content: center; gap: 6px; margin: 15px 0; flex-wrap: wrap; }
    .db-tab {
        padding: 8px 14px;
        border: 2px solid #e5e3dc;
        background: #fff;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        color: #6b6b6b;
        cursor: pointer;
        transition: all 0.2s;
    }
    .db-tab:hover { border-color: #c96442; color: #c96442; }
    .db-tab.active { background: #c96442; border-color: #c96442; color: #fff; }
    .db-tab .count {
        display: inline-block;
        background: rgba(0,0,0,0.1);
        padding: 1px 6px;
        border-radius: 8px;
        font-size: 10px;
        margin-left: 3px;
    }
    .db-tab.active .count { background: rgba(255,255,255,0.3); }
    
    .loading-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: #f5f4ef;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        z-index: 9999;
    }
    .loading-overlay.hidden { display: none; }
    .loading-spinner {
        width: 40px; height: 40px;
        border: 3px solid #e5e3dc; border-top-color: #c96442;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { color: #6b6b6b; font-size: 14px; }
    
    .search-section {
        background: #fff;
        border: 1px solid #e5e3dc;
        border-radius: 16px;
        padding: 14px;
        margin-bottom: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    
    .main-search { position: relative; margin-bottom: 10px; }
    .main-search::before {
        content: "ğŸ”"; position: absolute; left: 14px; top: 50%;
        transform: translateY(-50%); font-size: 15px; z-index: 2;
    }
    #mainSearchInput {
        width: 100%; padding: 12px 12px 12px 44px;
        border: 2px solid #e5e3dc; border-radius: 25px;
        background: #fafaf8; color: #2d2d2d; font-size: 15px;
    }
    #mainSearchInput:focus { outline: none; border-color: #c96442; background: #fff; }
    #mainSearchInput::placeholder { color: #9a9a9a; }
    
    .search-suggestions {
        position: absolute; top: 100%; left: 0; right: 0;
        background: #fff; border: 1px solid #e5e3dc; border-radius: 12px;
        margin-top: 4px; max-height: 320px; overflow-y: auto;
        z-index: 100; display: none;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    .search-suggestions.active { display: block; }
    .suggestion-group { padding: 6px 0; border-bottom: 1px solid #f0eeea; }
    .suggestion-group:last-child { border-bottom: none; }
    .suggestion-group-title { padding: 4px 12px; font-size: 10px; color: #8b8b8b; text-transform: uppercase; }
    .suggestion-item { padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 8px; }
    .suggestion-item:hover { background: #fafaf8; }
    .suggestion-icon { width: 26px; height: 26px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px; }
    .suggestion-icon.company { background: #e8f5ec; }
    .suggestion-icon.tag { background: #fff3e6; }
    .suggestion-icon.stock { background: #e6f0ff; }
    .suggestion-text { flex: 1; }
    .suggestion-main { font-size: 13px; color: #2d2d2d; }
    .suggestion-sub { font-size: 11px; color: #8b8b8b; }
    .suggestion-count { font-size: 11px; color: #8b8b8b; background: #f0eeea; padding: 2px 6px; border-radius: 8px; }
    .suggestion-action { font-size: 10px; color: #c96442; padding: 2px 6px; background: #fff3e6; border-radius: 6px; }
    
    .hot-tags { margin-bottom: 10px; }
    .hot-tags-title { font-size: 11px; color: #8b8b8b; margin-bottom: 6px; }
    .hot-tags-list { display: flex; flex-wrap: wrap; gap: 5px; }
    .hot-tag {
        padding: 5px 10px;
        background: linear-gradient(135deg, #fff3e6 0%, #ffe6cc 100%);
        border: none; border-radius: 12px;
        font-size: 12px; color: #c96442; cursor: pointer;
    }
    .hot-tag:hover { transform: translateY(-1px); }
    .hot-tag.active { background: #c96442; color: #fff; }
    
    .filter-row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .filter-select { flex: 1; min-width: 100px; }
    .filter-select select {
        width: 100%; padding: 9px 10px;
        border: 1px solid #e5e3dc; border-radius: 18px;
        background: #fafaf8; color: #2d2d2d; font-size: 12px;
        cursor: pointer; appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' fill='%236b6b6b' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
        background-repeat: no-repeat; background-position: right 10px center;
    }
    .filter-select select:focus { outline: none; border-color: #c96442; }
    .clear-all-btn {
        padding: 9px 14px; background: transparent;
        border: 1px solid #d64545; border-radius: 18px;
        font-size: 12px; color: #d64545; cursor: pointer;
    }
    
    .active-filters { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; }
    .active-filter {
        display: inline-flex; align-items: center; gap: 5px;
        padding: 4px 8px; background: #c96442; color: #fff;
        border-radius: 12px; font-size: 11px;
    }
    .active-filter .remove { cursor: pointer; opacity: 0.8; }
    
    .stats-bar {
        display: flex; justify-content: space-between; align-items: center;
        padding: 6px 0; margin-bottom: 10px; font-size: 12px; color: #6b6b6b;
    }
    .stats-bar strong { color: #c96442; }
    .sort-options { display: flex; gap: 6px; }
    .sort-btn {
        padding: 4px 10px; background: #eceae3; border: none;
        border-radius: 10px; font-size: 11px; color: #5a5a5a; cursor: pointer;
    }
    .sort-btn.active { background: #c96442; color: #fff; }
    
    .reports-list { display: flex; flex-direction: column; gap: 10px; }
    
    .card-base {
        background: #fff; border: 1px solid #e5e3dc; border-radius: 14px;
        padding: 14px; cursor: pointer; transition: all 0.2s;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .card-base:hover { border-color: #c96442; box-shadow: 0 4px 16px rgba(201,100,66,0.12); }
    
    .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
    .card-left { display: flex; align-items: center; gap: 8px; flex: 1; }
    .company-name { font-size: 15px; font-weight: 700; color: #2d2d2d; }
    .company-link { color: #c96442; cursor: pointer; text-decoration: underline; }
    .company-link:hover { color: #a85035; }
    .stock-code { font-size: 11px; color: #8b8b8b; background: #f0eeea; padding: 2px 6px; border-radius: 6px; cursor: pointer; }
    .stock-code:hover { background: #c96442; color: #fff; }
    .importance { color: #f5a623; font-size: 11px; letter-spacing: -2px; }
    
    .card-meta { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
    .meta-tag { font-size: 10px; padding: 3px 8px; border-radius: 10px; font-weight: 500; }
    .meta-tag.broker { background: #c96442; color: #fff; }
    .meta-tag.category { background: #5a9e6f; color: #fff; }
    .meta-tag.industry { background: #6b8cce; color: #fff; }
    .meta-tag.date { background: #eceae3; color: #5a5a5a; }
    .meta-tag.analyst { background: #e6f0ff; color: #4a6fa5; }
    
    .card-content {
        font-size: 13px; color: #5a5a5a; line-height: 1.6; margin-bottom: 8px;
        display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
    }
    
    .card-tags { display: flex; flex-wrap: wrap; gap: 4px; }
    .mini-tag { font-size: 10px; padding: 2px 6px; background: #fff3e6; color: #c96442; border-radius: 6px; }
    
    .card-data { display: flex; gap: 12px; flex-wrap: wrap; padding-top: 8px; border-top: 1px solid #f0eeea; margin-top: 8px; }
    .data-item { font-size: 11px; }
    .data-label { color: #8b8b8b; }
    .data-value { color: #2d2d2d; font-weight: 600; }
    .data-value.positive { color: #2e7d46; }
    .data-value.negative { color: #d64545; }
    
    .trend-card { background: linear-gradient(135deg, #fff 0%, #f0fdf4 100%); border: 2px solid #5a9e6f; }
    .trend-badge { display: inline-block; font-size: 10px; padding: 2px 8px; background: #5a9e6f; color: #fff; border-radius: 8px; margin-bottom: 6px; }
    
    /* å…¬å¸è³‡è¨Šå¡ç‰‡æ¨£å¼ */
    .stock-card {
        background: linear-gradient(135deg, #fff 0%, #f8f9ff 100%);
        border: 2px solid #6b8cce;
    }
    .stock-badge { display: inline-block; font-size: 10px; padding: 2px 8px; background: #6b8cce; color: #fff; border-radius: 8px; margin-bottom: 6px; }
    
    .modal-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5); z-index: 1000;
        display: none; overflow-y: auto; padding: 15px 10px;
    }
    .modal-overlay.active { display: block; }
    
    .modal-content {
        max-width: 800px; margin: 0 auto;
        background: #fff; border-radius: 18px; overflow: hidden;
        box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    }
    
    .modal-header {
        padding: 16px; background: #fafaf8;
        border-bottom: 1px solid #e5e3dc;
        display: flex; justify-content: space-between; align-items: flex-start;
    }
    .modal-header-info { flex: 1; }
    .modal-meta { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
    .modal-title { font-size: 18px; font-weight: 700; color: #2d2d2d; margin-bottom: 3px; }
    .modal-subtitle { font-size: 13px; color: #6b6b6b; }
    .modal-close {
        width: 32px; height: 32px; border: none; background: #eceae3;
        border-radius: 50%; color: #5a5a5a; font-size: 18px; cursor: pointer; margin-left: 10px;
    }
    
    .modal-body { padding: 16px; }
    .modal-section { margin-bottom: 18px; }
    .modal-section:last-child { margin-bottom: 0; }
    .section-title {
        font-size: 13px; font-weight: 600; color: #c96442;
        margin-bottom: 10px; padding-bottom: 6px; border-bottom: 1px solid #eceae3;
    }
    
    .content-block {
        background: #fafaf8; border-radius: 10px; padding: 12px;
        font-size: 13px; color: #2d2d2d; line-height: 1.8; white-space: pre-wrap;
    }
    
    .tags-block { display: flex; flex-wrap: wrap; gap: 5px; }
    .modal-tag {
        font-size: 12px; padding: 4px 10px;
        background: #fff3e6; color: #c96442;
        border-radius: 12px; cursor: pointer;
    }
    .modal-tag:hover { background: #c96442; color: #fff; }
    
    .info-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
    .info-item { background: #fafaf8; padding: 10px; border-radius: 8px; }
    .info-label { font-size: 11px; color: #8b8b8b; margin-bottom: 3px; }
    .info-value { font-size: 13px; font-weight: 600; color: #2d2d2d; }
    
    .timeline-item {
        padding: 10px; background: #fafaf8; border-radius: 8px;
        margin-bottom: 8px; border-left: 3px solid #c96442;
    }
    .timeline-date { font-size: 11px; color: #c96442; font-weight: 600; }
    .timeline-event { font-size: 13px; color: #2d2d2d; margin: 4px 0; }
    .timeline-note { font-size: 11px; color: #6b6b6b; }
    
    .product-item { background: #fafaf8; padding: 10px; border-radius: 8px; margin-bottom: 8px; }
    .product-name { font-size: 13px; font-weight: 600; color: #2d2d2d; }
    .product-ratio { font-size: 12px; color: #5a9e6f; }
    
    .concept-tag {
        display: inline-block; padding: 4px 10px;
        background: #e6f0ff; color: #4a6fa5;
        border-radius: 12px; font-size: 11px; margin: 2px;
    }
    
    .empty-state { text-align: center; padding: 50px 20px; color: #8b8b8b; }
    .empty-state .icon { font-size: 36px; margin-bottom: 10px; }
    
    @media (max-width: 600px) {
        .container { padding: 10px; }
        .header h1 { font-size: 18px; }
        .db-tab { padding: 6px 10px; font-size: 11px; }
        .filter-row { flex-direction: column; }
        .filter-select { min-width: 100%; }
        .modal-title { font-size: 16px; }
        .info-grid { grid-template-columns: 1fr 1fr; }
    }
</style>
```

</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">æ­£åœ¨è¼‰å…¥ç ”ç©¶å ±å‘Š...</div>
    </div>

```
<div class="container">
    <div class="header">
        <h1>ğŸ“Š Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤</h1>
        <p class="subtitle">åˆ¸å•†ç ”ç©¶å ±å‘Š Ã— å¤–é›»å¿«å ± Ã— Call Memo Ã— å…¬å¸è³‡æ–™åº«</p>
    </div>
    
    <div class="db-switcher">
        <button class="db-tab active" data-db="news" onclick="switchDB('news')">âš¡å¤–é›» <span class="count" id="newsCount">0</span></button>
        <button class="db-tab" data-db="memo" onclick="switchDB('memo')">ğŸ“‹Memo <span class="count" id="memoCount">0</span></button>
        <button class="db-tab" data-db="reports" onclick="switchDB('reports')">ğŸ“‘å±•æœ› <span class="count" id="reportsCount">0</span></button>
        <button class="db-tab" data-db="trends" onclick="switchDB('trends')">ğŸ“ˆè¶¨å‹¢ <span class="count" id="trendsCount">0</span></button>
        <button class="db-tab" data-db="stocks" onclick="switchDB('stocks')">ğŸ¢å€‹è‚¡ <span class="count" id="stocksCount">0</span></button>
    </div>
    
    <div class="search-section">
        <div class="main-search">
            <input type="text" id="mainSearchInput" placeholder="æœå°‹å…¬å¸ã€ä»£è™Ÿã€æ¨™ç±¤ã€åˆ¸å•†...">
            <div class="search-suggestions" id="searchSuggestions"></div>
        </div>
        
        <div class="hot-tags">
            <div class="hot-tags-title">ğŸ”¥ ç†±é–€é—œéµå­—</div>
            <div class="hot-tags-list" id="hotTagsList"></div>
        </div>
        
        <div class="filter-row">
            <div class="filter-select"><select id="brokerFilter"><option value="">æ‰€æœ‰åˆ¸å•†</option></select></div>
            <div class="filter-select" id="categoryFilterWrap"><select id="categoryFilter"><option value="">æ‰€æœ‰åˆ†é¡</option></select></div>
            <div class="filter-select" id="importanceFilterWrap">
                <select id="importanceFilter">
                    <option value="">æ‰€æœ‰é‡è¦æ€§</option>
                    <option value="â­â­â­â­â­">â­â­â­â­â­</option>
                    <option value="â­â­â­â­">â­â­â­â­</option>
                    <option value="â­â­â­">â­â­â­</option>
                </select>
            </div>
            <div class="filter-select" id="industryFilterWrap" style="display:none;"><select id="industryFilter"><option value="">æ‰€æœ‰ç”¢æ¥­</option></select></div>
            <div class="filter-select" id="marketFilterWrap" style="display:none;"><select id="marketFilter"><option value="">æ‰€æœ‰å¸‚å ´</option></select></div>
            <button class="clear-all-btn" onclick="clearAllFilters()">æ¸…é™¤</button>
        </div>
        
        <div class="active-filters" id="activeFilters"></div>
    </div>
    
    <div class="stats-bar">
        <span>æ‰¾åˆ° <strong id="filteredCount">0</strong> ç­†çµæœ</span>
        <div class="sort-options">
            <button class="sort-btn active" data-sort="date" onclick="setSort('date')">æœ€æ–°</button>
            <button class="sort-btn" data-sort="importance" onclick="setSort('importance')">é‡è¦æ€§</button>
        </div>
    </div>
    
    <div class="reports-list" id="reportsList"></div>
</div>

<div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <div class="modal-header-info" id="modalHeaderInfo"></div>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" id="modalBody"></div>
    </div>
</div>

<script>
    const NEWS_FILE = 'å¤–é›»ç¶œåˆå ±å°è³‡æ–™åº«_å®Œæ•´çè—ç‰ˆ.xlsx';
    const REPORTS_FILE = 'æŠ•è³‡å±•æœ›å ±å‘Šæ”¶é›†æ¨¡æ¿_æ›´æ–°ç‰ˆ.xlsx';
    const MEMO_FILE = 'ç ”ç©¶å ±å‘Šè³‡æ–™åº«_å®Œå…¨ä¿®æ­£ç‰ˆ_71ç¯‡.xlsx';
    const MASTER_FILE = 'Rexç”¢æ¥­ç ”ç©¶è³‡æ–™åº«_çµ‚æ¥µæ•´åˆç‰ˆ_å«æ¦‚å¿µè‚¡.xlsx';
    
    let newsData = [], newsContent = {}, trendsData = [];
    let reportsData = [], reportDetails = {}, reportStocksData = {};
    let memoData = [], memoDetails = {}, memoFinance = {}, memoProducts = {}, memoTimeline = [];
    let masterStocks = {}, conceptStocks = [];
    
    let currentDB = 'news';
    let currentSort = 'date';
    let activeFilters = { search: '', broker: '', category: '', importance: '', industry: '', tag: '', market: '' };
    let searchIndex = { companies: {}, tags: {}, brokers: {}, stocks: {} };
    
    window.onload = async function() {
        try {
            await Promise.all([loadNewsData(), loadReportsData(), loadMemoData(), loadMasterData()]);
            buildSearchIndex();
            buildFilters();
            buildHotTags();
            updateCounts();
            renderCurrentDB();
            document.getElementById('loadingOverlay').classList.add('hidden');
            
            const searchInput = document.getElementById('mainSearchInput');
            searchInput.addEventListener('input', onSearchInput);
            searchInput.addEventListener('focus', () => showSuggestions());
            document.addEventListener('click', (e) => { if (!e.target.closest('.main-search')) hideSuggestions(); });
        } catch (error) {
            console.error('è¼‰å…¥å¤±æ•—:', error);
            document.getElementById('loadingOverlay').innerHTML = `<div style="text-align:center;color:#d64545;"><h2>âŒ è¼‰å…¥å¤±æ•—</h2><p>${error.message}</p><button onclick="location.reload()" style="margin-top:20px;padding:12px 30px;background:#c96442;border:none;border-radius:25px;color:#fff;cursor:pointer;">é‡æ–°è¼‰å…¥</button></div>`;
        }
    };
    
    async function loadNewsData() {
        try {
            const response = await fetch(NEWS_FILE);
            if (!response.ok) return;
            const ab = await response.arrayBuffer();
            const wb = XLSX.read(ab, { type: 'array' });
            
            const s1 = wb.Sheets['å ±å°ç¸½è¡¨'];
            if (s1) XLSX.utils.sheet_to_json(s1).forEach(r => {
                if (!r['ç·¨è™Ÿ']) return;
                newsData.push({ id: r['ç·¨è™Ÿ'], date: r['æ—¥æœŸ'] || '', company: r['å…¬å¸'] || '', stockCode: r['è‚¡è™Ÿ'] || '', broker: r['åˆ¸å•†ä¾†æº'] || '', category: r['å ±å°é‡é»åˆ†é¡'] || '', importance: r['é‡è¦æ€§'] || '', tags: r['æ¨™ç±¤'] || '' });
            });
            
            const s2 = wb.Sheets['å®Œæ•´å…§å®¹æ”¶éŒ„'];
            if (s2) XLSX.utils.sheet_to_json(s2).forEach(r => { if (r['ç·¨è™Ÿ']) newsContent[r['ç·¨è™Ÿ']] = r['å®Œæ•´å ±å°å…§å®¹'] || ''; });
            
            const s3 = wb.Sheets['ç”¢æ¥­è¶¨å‹¢å°ˆå€'];
            if (s3) XLSX.utils.sheet_to_json(s3).forEach(r => {
                if (!r['ç·¨è™Ÿ']) return;
                trendsData.push({ id: r['ç·¨è™Ÿ'], date: r['æ—¥æœŸ'] || '', topic: r['ç”¢æ¥­ä¸»é¡Œ'] || '', broker: r['åˆ¸å•†ä¾†æº'] || '', content: r['å®Œæ•´å…§å®¹'] || '', companies: r['ç›¸é—œå…¬å¸ç¾¤'] || '', tags: r['æ¨™ç±¤'] || '' });
            });
        } catch(e) { console.log('å¤–é›»è¼‰å…¥è·³é:', e); }
    }
    
    async function loadReportsData() {
        try {
            const response = await fetch(REPORTS_FILE);
            if (!response.ok) return;
            const ab = await response.arrayBuffer();
            const wb = XLSX.read(ab, { type: 'array' });
            
            const s1 = wb.Sheets['å ±å‘Šç¸½è¦½'];
            if (s1) XLSX.utils.sheet_to_json(s1).forEach(r => {
                if (!r['å ±å‘Šç·¨è™Ÿ']) return;
                const report = { id: r['å ±å‘Šç·¨è™Ÿ'], broker: r['åˆ¸å•†åç¨±'] || '', date: formatDate(r['å ±å‘Šæ—¥æœŸ']), industry: r['ç”¢æ¥­åç¨±'] || '', title: r['å ±å‘Šæ¨™é¡Œ'] || '', subtitle: r['å‰¯æ¨™é¡Œ'] || '', rating: r['ç”¢æ¥­è©•ç­‰'] || '', highlights: [] };
                for (let i = 1; i <= 5; i++) if (r[`æ ¸å¿ƒé‡é»${i}`]) report.highlights.push(r[`æ ¸å¿ƒé‡é»${i}`]);
                reportsData.push(report);
            });
            
            const s2 = wb.Sheets['ç„¦é»åˆ†æå…§å®¹'];
            if (s2) XLSX.utils.sheet_to_json(s2).forEach(r => {
                if (!r['å ±å‘Šç·¨è™Ÿ']) return;
                if (!reportDetails[r['å ±å‘Šç·¨è™Ÿ']]) reportDetails[r['å ±å‘Šç·¨è™Ÿ']] = [];
                reportDetails[r['å ±å‘Šç·¨è™Ÿ']].push({ sectionTitle: r['æ®µè½æ¨™é¡Œ'] || '', content: r['æ®µè½å…§å®¹'] || '' });
            });
            
            const s3 = wb.Sheets['å€‹è‚¡è©•åƒ¹è¡¨'];
            if (s3) XLSX.utils.sheet_to_json(s3).forEach(r => {
                if (!r['å ±å‘Šç·¨è™Ÿ']) return;
                if (!reportStocksData[r['å ±å‘Šç·¨è™Ÿ']]) reportStocksData[r['å ±å‘Šç·¨è™Ÿ']] = [];
                reportStocksData[r['å ±å‘Šç·¨è™Ÿ']].push({ name: r['å…¬å¸åç¨±'] || '', code: r['è‚¡ç¥¨ä»£è™Ÿ'] || '', rating: r['è©•ç­‰'] || '', target: r['ç›®æ¨™åƒ¹'], highlight: r['æŠ•è³‡äº®é»'] || '' });
            });
        } catch(e) { console.log('å±•æœ›è¼‰å…¥è·³é:', e); }
    }
    
    async function loadMemoData() {
        try {
            const response = await fetch(MEMO_FILE);
            if (!response.ok) return;
            const ab = await response.arrayBuffer();
            const wb = XLSX.read(ab, { type: 'array' });
            
            const s1 = wb.Sheets['å ±å‘Šç¸½è¡¨'];
            if (s1) XLSX.utils.sheet_to_json(s1).forEach(r => {
                if (!r['ç·¨è™Ÿ']) return;
                memoData.push({ id: r['ç·¨è™Ÿ'], date: r['æ—¥æœŸ'] || '', company: r['å…¬å¸'] || '', stockCode: r['è‚¡è™Ÿ'] || '', broker: r['åˆ¸å•†'] || '', analyst: r['åˆ†æå¸«'] || '', type: r['å ±å‘Šé¡å‹'] || '', importance: r['é‡è¦æ€§'] || '', industry: r['ç”¢æ¥­'] || '', revenueYoY: r['ç‡Ÿæ”¶YoY'] || '', grossMargin: r['æ¯›åˆ©ç‡'] || '', eps: r['EPS'] || '' });
            });
            
            const s2 = wb.Sheets['è©³ç´°å…§å®¹åº«'];
            if (s2) XLSX.utils.sheet_to_json(s2).forEach(r => {
                if (!r['ç·¨è™Ÿ']) return;
                memoDetails[r['ç·¨è™Ÿ']] = { operation: r['ç‡Ÿé‹é‡é»'] || '', strategy: r['ç­–ç•¥æ–¹å‘'] || '', qa: r['é‡è¦QAæ‘˜è¦'] || '', rexView: r['Rexè§€å¯Ÿ'] || '', followUp: r['å¾ŒçºŒè¿½è¹¤'] || '', tags: r['æ¨™ç±¤'] || '' };
            });
            
            const s3 = wb.Sheets['è²¡å‹™æ•¸æ“šå½™ç¸½'];
            if (s3) XLSX.utils.sheet_to_json(s3).forEach(r => {
                if (!r['å…¬å¸']) return;
                memoFinance[r['å…¬å¸']] = { revenue: r['3Q25ç‡Ÿæ”¶'] || '', revenueYoY: r['ç‡Ÿæ”¶YoY'] || '', revenueQoQ: r['ç‡Ÿæ”¶QoQ'] || '', grossMargin: r['æ¯›åˆ©ç‡'] || '', netIncome: r['ç¨…å¾Œæ·¨åˆ©'] || '', eps: r['EPS'] || '', guidance: r['4Q25æŒ‡å¼•'] || '' };
            });
            
            const s4 = wb.Sheets['ç”¢å“çµæ§‹åˆ†æ'];
            if (s4) XLSX.utils.sheet_to_json(s4).forEach(r => {
                if (!r['å…¬å¸']) return;
                memoProducts[r['å…¬å¸']] = { products: [{ name: r['ä¸»è¦ç”¢å“1'], ratio: r['ä½”æ¯”/è¡¨ç¾1'] }, { name: r['ä¸»è¦ç”¢å“2'], ratio: r['ä½”æ¯”/è¡¨ç¾2'] }, { name: r['ä¸»è¦ç”¢å“3'], ratio: r['ä½”æ¯”/è¡¨ç¾3'] }].filter(p => p.name), driver: r['é—œéµæˆé•·å‹•èƒ½'] || '', outlook2026: r['2026å±•æœ›'] || '' };
            });
            
            const s5 = wb.Sheets['é—œéµæ™‚ç¨‹è¿½è¹¤'];
            if (s5) XLSX.utils.sheet_to_json(s5).forEach(r => {
                if (!r['å…¬å¸']) return;
                memoTimeline.push({ company: r['å…¬å¸'], time: r['æ™‚é–“'] || '', event: r['äº‹ä»¶'] || '', type: r['é¡å‹'] || '', importance: r['é‡è¦æ€§'] || '', impact: r['é æœŸå½±éŸ¿'] || '', status: r['è¿½è¹¤ç‹€æ…‹'] || '', note: r['å‚™è¨»'] || '' });
            });
        } catch(e) { console.log('Memoè¼‰å…¥è·³é:', e); }
    }
    
    async function loadMasterData() {
        try {
            const response = await fetch(MASTER_FILE);
            if (!response.ok) return;
            const ab = await response.arrayBuffer();
            const wb = XLSX.read(ab, { type: 'array' });
            
            const s1 = wb.Sheets['ä¸»è³‡æ–™åº«'];
            if (s1) XLSX.utils.sheet_to_json(s1).forEach(r => {
                if (!r['ä»£è™Ÿ']) return;
                const code = String(r['ä»£è™Ÿ']);
                masterStocks[code] = {
                    code: code, name: r['å…¬å¸åç¨±'] || '', market: r['å¸‚å ´åˆ†é¡'] || '',
                    industry: r['ç”¢æ¥­åˆ†é¡'] || '', subIndustry: r['ç”¢æ¥­ç´°åˆ†'] || '',
                    related: r['ç›¸é—œåˆ†é¡'] || '', position: r['ç”¢æ¥­åœ°ä½èªªæ˜'] || '',
                    price: r['æˆäº¤'] || '', change: r['æ¼²è·Œåƒ¹'] || '', changePercent: r['æ¼²è·Œå¹…'] || '',
                    volume: r['æˆäº¤å¼µæ•¸'] || '', parValue: r['é¢å€¼(å…ƒ)'] || '',
                    capital: r['è‚¡æœ¬(å„„)'] || '', marketCap: r['å¸‚å€¼(å„„)'] || '',
                    shares: r['ç™¼è¡Œé‡(è¬å¼µ)'] || '', foundedYears: r['æˆç«‹å¹´æ•¸'] || '',
                    listedYears: r['æ›ç‰Œå¹´æ•¸'] || '', chairman: r['è‘£äº‹é•·'] || '',
                    ceo: r['ç¸½ç¶“ç†'] || '', business: r['æ¥­å‹™æ‘˜è¦'] || '',
                    group: r['ç›¸é—œé›†åœ˜'] || '', hasFutures: r['è‚¡ç¥¨æœŸè²¨'] || '',
                    hasOptions: r['è‚¡ç¥¨é¸æ“‡æ¬Š'] || '', hasWarrant: r['æ¬Šè­‰'] || '',
                    hasBond: r['å…¬å¸å‚µ'] || '', updateDate: r['è³‡æ–™æ›´æ–°æ—¥æœŸ'] || ''
                };
                // åŒæ™‚ç”¨åç¨±åšç´¢å¼•
                if (r['å…¬å¸åç¨±']) masterStocks[r['å…¬å¸åç¨±']] = masterStocks[code];
            });
            
            const s2 = wb.Sheets['ğŸ’¡æ¦‚å¿µè‚¡æ—ç¾¤è³‡æ–™åº«'];
            if (s2) {
                const rows = XLSX.utils.sheet_to_json(s2, { header: 1 });
                for (let i = 3; i < rows.length; i++) {
                    const r = rows[i];
                    if (!r[0]) continue;
                    conceptStocks.push({
                        code: String(r[0]), name: r[1] || '', concept: r[2] || '',
                        subRole: r[3] || '', description: r[4] || '',
                        importance: r[5] || '', duration: r[6] || '',
                        source: r[7] || '', updateDate: r[8] || '', status: r[9] || ''
                    });
                }
            }
        } catch(e) { console.log('ä¸»è³‡æ–™åº«è¼‰å…¥è·³é:', e); }
    }
    
    function formatDate(v) {
        if (!v) return '';
        if (typeof v === 'string') return v;
        if (typeof v === 'number') { const d = new Date((v - 25569) * 86400 * 1000); return d.toLocaleDateString('zh-TW'); }
        return String(v);
    }
    
    function buildSearchIndex() {
        searchIndex = { companies: {}, tags: {}, brokers: {}, stocks: {} };
        
        // å¾ä¸»è³‡æ–™åº«å»ºç«‹è‚¡ç¥¨ç´¢å¼•
        Object.values(masterStocks).forEach(s => {
            if (s.code && !searchIndex.stocks[s.code]) {
                searchIndex.stocks[s.code] = { name: s.name, code: s.code, market: s.market, industry: s.industry };
            }
        });
        
        newsData.forEach(item => {
            if (item.company) {
                if (!searchIndex.companies[item.company]) searchIndex.companies[item.company] = { count: 0, code: item.stockCode };
                searchIndex.companies[item.company].count++;
            }
            if (item.tags) item.tags.split('#').filter(t => t.trim()).forEach(tag => {
                const t = tag.trim();
                if (!searchIndex.tags[t]) searchIndex.tags[t] = 0;
                searchIndex.tags[t]++;
            });
            if (item.broker) { if (!searchIndex.brokers[item.broker]) searchIndex.brokers[item.broker] = 0; searchIndex.brokers[item.broker]++; }
        });
        
        memoData.forEach(item => {
            if (item.company) {
                if (!searchIndex.companies[item.company]) searchIndex.companies[item.company] = { count: 0, code: item.stockCode };
                searchIndex.companies[item.company].count++;
            }
            const detail = memoDetails[item.id];
            if (detail && detail.tags) detail.tags.split('#').filter(t => t.trim()).forEach(tag => {
                const t = tag.trim();
                if (!searchIndex.tags[t]) searchIndex.tags[t] = 0;
                searchIndex.tags[t]++;
            });
        });
    }
    
    function buildFilters() {
        const brokers = [...new Set([...newsData.map(n => n.broker), ...memoData.map(m => m.broker), ...reportsData.map(r => r.broker)])].filter(Boolean).sort();
        document.getElementById('brokerFilter').innerHTML = '<option value="">æ‰€æœ‰åˆ¸å•†</option>' + brokers.map(b => `<option value="${b}">${b}</option>`).join('');
        
        const categories = [...new Set(newsData.map(n => n.category))].filter(Boolean).sort();
        document.getElementById('categoryFilter').innerHTML = '<option value="">æ‰€æœ‰åˆ†é¡</option>' + categories.map(c => `<option value="${c}">${c}</option>`).join('');
        
        const industries = [...new Set([...reportsData.map(r => r.industry), ...memoData.map(m => m.industry), ...Object.values(masterStocks).map(s => s.industry)])].filter(Boolean).sort();
        document.getElementById('industryFilter').innerHTML = '<option value="">æ‰€æœ‰ç”¢æ¥­</option>' + industries.map(i => `<option value="${i}">${i}</option>`).join('');
        
        const markets = [...new Set(Object.values(masterStocks).map(s => s.market))].filter(Boolean).sort();
        document.getElementById('marketFilter').innerHTML = '<option value="">æ‰€æœ‰å¸‚å ´</option>' + markets.map(m => `<option value="${m}">${m}</option>`).join('');
        
        document.getElementById('brokerFilter').onchange = applyFilters;
        document.getElementById('categoryFilter').onchange = applyFilters;
        document.getElementById('importanceFilter').onchange = applyFilters;
        document.getElementById('industryFilter').onchange = applyFilters;
        document.getElementById('marketFilter').onchange = applyFilters;
    }
    
    function buildHotTags() {
        const topTags = Object.entries(searchIndex.tags).sort((a, b) => b[1] - a[1]).slice(0, 10);
        document.getElementById('hotTagsList').innerHTML = topTags.map(([tag]) => `<button class="hot-tag" onclick="searchByTag('${tag}')">#${tag}</button>`).join('');
    }
    
    function onSearchInput(e) {
        const query = e.target.value.trim().toLowerCase();
        if (query.length > 0) showSuggestions(query);
        else hideSuggestions();
        activeFilters.search = query;
        renderCurrentDB();
    }
    
    function showSuggestions(query = '') {
        const container = document.getElementById('searchSuggestions');
        if (!query) {
            const topCompanies = Object.entries(searchIndex.companies).sort((a, b) => b[1].count - a[1].count).slice(0, 5);
            const topTags = Object.entries(searchIndex.tags).sort((a, b) => b[1] - a[1]).slice(0, 5);
            container.innerHTML = `
                <div class="suggestion-group"><div class="suggestion-group-title">ç†±é–€å…¬å¸</div>
                    ${topCompanies.map(([name, data]) => `<div class="suggestion-item" onclick="searchByCompany('${name}')"><div class="suggestion-icon company">ğŸ¢</div><div class="suggestion-text"><div class="suggestion-main">${name}</div><div class="suggestion-sub">${data.code || ''}</div></div><span class="suggestion-count">${data.count}ç­†</span></div>`).join('')}
                </div>
                <div class="suggestion-group"><div class="suggestion-group-title">ç†±é–€æ¨™ç±¤</div>
                    ${topTags.map(([tag, count]) => `<div class="suggestion-item" onclick="searchByTag('${tag}')"><div class="suggestion-icon tag">ğŸ·ï¸</div><div class="suggestion-text"><div class="suggestion-main">#${tag}</div></div><span class="suggestion-count">${count}ç­†</span></div>`).join('')}
                </div>`;
            container.classList.add('active');
            return;
        }
        
        const matchedCompanies = Object.entries(searchIndex.companies).filter(([name]) => name.toLowerCase().includes(query)).sort((a, b) => b[1].count - a[1].count).slice(0, 5);
        const matchedTags = Object.entries(searchIndex.tags).filter(([tag]) => tag.toLowerCase().includes(query)).sort((a, b) => b[1] - a[1]).slice(0, 5);
        const matchedStocks = Object.entries(searchIndex.stocks).filter(([code, data]) => code.includes(query) || data.name.toLowerCase().includes(query)).slice(0, 5);
        
        let html = '';
        if (matchedStocks.length > 0) {
            html += `<div class="suggestion-group"><div class="suggestion-group-title">ğŸ“Š å€‹è‚¡è³‡æ–™</div>
                ${matchedStocks.map(([code, data]) => `<div class="suggestion-item" onclick="openStockModal('${code}')"><div class="suggestion-icon stock">ğŸ“ˆ</div><div class="suggestion-text"><div class="suggestion-main">${data.name}</div><div class="suggestion-sub">${code} | ${data.market} | ${data.industry}</div></div><span class="suggestion-action">æŸ¥çœ‹è³‡æ–™</span></div>`).join('')}</div>`;
        }
        if (matchedCompanies.length > 0) {
            html += `<div class="suggestion-group"><div class="suggestion-group-title">ğŸ” æœå°‹å ±å°</div>
                ${matchedCompanies.map(([name, data]) => `<div class="suggestion-item" onclick="searchByCompany('${name}')"><div class="suggestion-icon company">ğŸ¢</div><div class="suggestion-text"><div class="suggestion-main">${name}</div><div class="suggestion-sub">${data.code || ''}</div></div><span class="suggestion-count">${data.count}ç­†å ±å°</span></div>`).join('')}</div>`;
        }
        if (matchedTags.length > 0) {
            html += `<div class="suggestion-group"><div class="suggestion-group-title">ğŸ·ï¸ æ¨™ç±¤</div>
                ${matchedTags.map(([tag, count]) => `<div class="suggestion-item" onclick="searchByTag('${tag}')"><div class="suggestion-icon tag">ğŸ·ï¸</div><div class="suggestion-text"><div class="suggestion-main">#${tag}</div></div><span class="suggestion-count">${count}ç­†</span></div>`).join('')}</div>`;
        }
        
        if (html) { container.innerHTML = html; container.classList.add('active'); }
        else hideSuggestions();
    }
    
    function hideSuggestions() { document.getElementById('searchSuggestions').classList.remove('active'); }
    
    function searchByCompany(company) {
        document.getElementById('mainSearchInput').value = company;
        activeFilters.search = company.toLowerCase();
        hideSuggestions();
        renderCurrentDB();
    }
    
    function searchByTag(tag) {
        document.getElementById('mainSearchInput').value = '#' + tag;
        activeFilters.search = '';
        activeFilters.tag = tag;
        hideSuggestions();
        updateActiveFiltersDisplay();
        renderCurrentDB();
        document.querySelectorAll('.hot-tag').forEach(btn => btn.classList.toggle('active', btn.textContent === '#' + tag));
    }
    
    function switchDB(db) {
        currentDB = db;
        document.querySelectorAll('.db-tab').forEach(tab => tab.classList.toggle('active', tab.dataset.db === db));
        document.getElementById('categoryFilterWrap').style.display = (db === 'news') ? 'block' : 'none';
        document.getElementById('importanceFilterWrap').style.display = (db === 'news' || db === 'memo') ? 'block' : 'none';
        document.getElementById('industryFilterWrap').style.display = (db === 'reports' || db === 'memo' || db === 'stocks') ? 'block' : 'none';
        document.getElementById('marketFilterWrap').style.display = (db === 'stocks') ? 'block' : 'none';
        renderCurrentDB();
    }
    
    function applyFilters() {
        activeFilters.broker = document.getElementById('brokerFilter').value;
        activeFilters.category = document.getElementById('categoryFilter').value;
        activeFilters.importance = document.getElementById('importanceFilter').value;
        activeFilters.industry = document.getElementById('industryFilter').value;
        activeFilters.market = document.getElementById('marketFilter').value;
        updateActiveFiltersDisplay();
        renderCurrentDB();
    }
    
    function updateActiveFiltersDisplay() {
        const container = document.getElementById('activeFilters');
        let html = '';
        if (activeFilters.tag) html += `<span class="active-filter">#${activeFilters.tag} <span class="remove" onclick="removeFilter('tag')">âœ•</span></span>`;
        if (activeFilters.broker) html += `<span class="active-filter">${activeFilters.broker} <span class="remove" onclick="removeFilter('broker')">âœ•</span></span>`;
        if (activeFilters.category) html += `<span class="active-filter">${activeFilters.category} <span class="remove" onclick="removeFilter('category')">âœ•</span></span>`;
        if (activeFilters.importance) html += `<span class="active-filter">${activeFilters.importance} <span class="remove" onclick="removeFilter('importance')">âœ•</span></span>`;
        if (activeFilters.industry) html += `<span class="active-filter">${activeFilters.industry} <span class="remove" onclick="removeFilter('industry')">âœ•</span></span>`;
        if (activeFilters.market) html += `<span class="active-filter">${activeFilters.market} <span class="remove" onclick="removeFilter('market')">âœ•</span></span>`;
        container.innerHTML = html;
    }
    
    function removeFilter(type) {
        activeFilters[type] = '';
        if (type === 'broker') document.getElementById('brokerFilter').value = '';
        if (type === 'category') document.getElementById('categoryFilter').value = '';
        if (type === 'importance') document.getElementById('importanceFilter').value = '';
        if (type === 'industry') document.getElementById('industryFilter').value = '';
        if (type === 'market') document.getElementById('marketFilter').value = '';
        if (type === 'tag') { document.getElementById('mainSearchInput').value = ''; document.querySelectorAll('.hot-tag').forEach(btn => btn.classList.remove('active')); }
        updateActiveFiltersDisplay();
        renderCurrentDB();
    }
    
    function clearAllFilters() {
        activeFilters = { search: '', broker: '', category: '', importance: '', industry: '', tag: '', market: '' };
        document.getElementById('mainSearchInput').value = '';
        document.getElementById('brokerFilter').value = '';
        document.getElementById('categoryFilter').value = '';
        document.getElementById('importanceFilter').value = '';
        document.getElementById('industryFilter').value = '';
        document.getElementById('marketFilter').value = '';
        document.querySelectorAll('.hot-tag').forEach(btn => btn.classList.remove('active'));
        updateActiveFiltersDisplay();
        renderCurrentDB();
    }
    
    function setSort(sort) {
        currentSort = sort;
        document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.sort === sort));
        renderCurrentDB();
    }
    
    function updateCounts() {
        document.getElementById('newsCount').textContent = newsData.length;
        document.getElementById('memoCount').textContent = memoData.length;
        document.getElementById('reportsCount').textContent = reportsData.length;
        document.getElementById('trendsCount').textContent = trendsData.length;
        const uniqueStocks = new Set(Object.values(masterStocks).map(s => s.code));
        document.getElementById('stocksCount').textContent = uniqueStocks.size;
    }
    
    function renderCurrentDB() {
        if (currentDB === 'news') renderNews();
        else if (currentDB === 'memo') renderMemo();
        else if (currentDB === 'reports') renderReports();
        else if (currentDB === 'trends') renderTrends();
        else if (currentDB === 'stocks') renderStocks();
    }
    
    function renderNews() {
        let filtered = newsData.filter(item => {
            if (activeFilters.search) {
                const searchText = [item.company, item.stockCode, item.broker, item.category, item.tags, newsContent[item.id] || ''].join(' ').toLowerCase();
                if (!searchText.includes(activeFilters.search)) return false;
            }
            if (activeFilters.tag && !item.tags.includes(activeFilters.tag)) return false;
            if (activeFilters.broker && item.broker !== activeFilters.broker) return false;
            if (activeFilters.category && item.category !== activeFilters.category) return false;
            if (activeFilters.importance && item.importance !== activeFilters.importance) return false;
            return true;
        });
        
        if (currentSort === 'importance') filtered.sort((a, b) => (b.importance?.length || 0) - (a.importance?.length || 0));
        else filtered.sort((a, b) => String(b.date).localeCompare(String(a.date)));
        
        document.getElementById('filteredCount').textContent = filtered.length;
        const list = document.getElementById('reportsList');
        if (filtered.length === 0) { list.innerHTML = `<div class="empty-state"><div class="icon">ğŸ”</div><p>æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å ±å°</p></div>`; return; }
        
        list.innerHTML = filtered.map(item => {
            const content = newsContent[item.id] || '';
            const preview = content.replace(/â€¢/g, '').substring(0, 100);
            const tags = item.tags.split('#').filter(t => t.trim()).slice(0, 3);
            return `<div class="card-base" onclick="openNewsModal('${item.id}')">
                <div class="card-header">
                    <div class="card-left">
                        <span class="company-name company-link" onclick="event.stopPropagation();openStockModal('${item.stockCode}')">${item.company}</span>
                        ${item.stockCode && item.stockCode !== '-' ? `<span class="stock-code" onclick="event.stopPropagation();openStockModal('${item.stockCode}')">${item.stockCode}</span>` : ''}
                    </div>
                    <span class="importance">${item.importance}</span>
                </div>
                <div class="card-meta">
                    <span class="meta-tag broker">${item.broker}</span>
                    <span class="meta-tag category">${item.category}</span>
                    <span class="meta-tag date">${item.date}</span>
                </div>
                <div class="card-content">${preview}...</div>
                <div class="card-tags">${tags.map(t => `<span class="mini-tag">#${t.trim()}</span>`).join('')}</div>
            </div>`;
        }).join('');
    }
    
    function renderMemo() {
        let filtered = memoData.filter(item => {
            const detail = memoDetails[item.id] || {};
            if (activeFilters.search) {
                const searchText = [item.company, item.stockCode, item.broker, item.analyst, item.industry, detail.operation || '', detail.strategy || '', detail.tags || ''].join(' ').toLowerCase();
                if (!searchText.includes(activeFilters.search)) return false;
            }
            if (activeFilters.tag && !(detail.tags || '').includes(activeFilters.tag)) return false;
            if (activeFilters.broker && item.broker !== activeFilters.broker) return false;
            if (activeFilters.importance && item.importance !== activeFilters.importance) return false;
            if (activeFilters.industry && item.industry !== activeFilters.industry) return false;
            return true;
        });
        
        if (currentSort === 'importance') filtered.sort((a, b) => (b.importance?.length || 0) - (a.importance?.length || 0));
        else filtered.sort((a, b) => String(b.date).localeCompare(String(a.date)));
        
        document.getElementById('filteredCount').textContent = filtered.length;
        const list = document.getElementById('reportsList');
        if (filtered.length === 0) { list.innerHTML = `<div class="empty-state"><div class="icon">ğŸ”</div><p>æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å ±å‘Š</p></div>`; return; }
        
        list.innerHTML = filtered.map(item => {
            const detail = memoDetails[item.id] || {};
            const preview = (detail.operation || '').substring(0, 100);
            const tags = (detail.tags || '').split('#').filter(t => t.trim()).slice(0, 3);
            return `<div class="card-base" onclick="openMemoModal('${item.id}')">
                <div class="card-header">
                    <div class="card-left">
                        <span class="company-name company-link" onclick="event.stopPropagation();openStockModal('${item.stockCode}')">${item.company}</span>
                        <span class="stock-code" onclick="event.stopPropagation();openStockModal('${item.stockCode}')">${item.stockCode}</span>
                    </div>
                    <span class="importance">${item.importance}</span>
                </div>
                <div class="card-meta">
                    <span class="meta-tag broker">${item.broker}</span>
                    <span class="meta-tag industry">${item.industry}</span>
                    <span class="meta-tag analyst">${item.analyst}</span>
                    <span class="meta-tag date">${item.date}</span>
                </div>
                <div class="card-content">${preview}...</div>
                <div class="card-data">
                    <div class="data-item"><span class="data-label">ç‡Ÿæ”¶YoY </span><span class="data-value ${item.revenueYoY.includes('+') ? 'positive' : ''}">${item.revenueYoY}</span></div>
                    <div class="data-item"><span class="data-label">æ¯›åˆ©ç‡ </span><span class="data-value">${item.grossMargin}</span></div>
                    <div class="data-item"><span class="data-label">EPS </span><span class="data-value">${item.eps}</span></div>
                </div>
                <div class="card-tags" style="margin-top:8px;">${tags.map(t => `<span class="mini-tag">#${t.trim()}</span>`).join('')}</div>
            </div>`;
        }).join('');
    }
    
    function renderReports() {
        let filtered = reportsData.filter(report => {
            if (activeFilters.search) {
                const searchText = [report.title, report.subtitle, report.broker, report.industry, report.highlights.join(' ')].join(' ').toLowerCase();
                if (!searchText.includes(activeFilters.search)) return false;
            }
            if (activeFilters.broker && report.broker !== activeFilters.broker) return false;
            if (activeFilters.industry && report.industry !== activeFilters.industry) return false;
            return true;
        });
        
        filtered.sort((a, b) => String(b.date).localeCompare(String(a.date)));
        document.getElementById('filteredCount').textContent = filtered.length;
        const list = document.getElementById('reportsList');
        if (filtered.length === 0) { list.innerHTML = `<div class="empty-state"><div class="icon">ğŸ”</div><p>æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å ±å‘Š</p></div>`; return; }
        
        list.innerHTML = filtered.map(report => {
            const stocks = reportStocksData[report.id] || [];
            return `<div class="card-base" onclick="openReportModal('${report.id}')">
                <div class="card-meta">
                    <span class="meta-tag broker">${report.broker}</span>
                    <span class="meta-tag industry">${report.industry}</span>
                    <span class="meta-tag date">${report.date}</span>
                </div>
                <div class="company-name" style="margin:8px 0 4px;font-size:16px;">${report.title}</div>
                ${report.subtitle ? `<div style="font-size:13px;color:#6b6b6b;margin-bottom:8px;">${report.subtitle}</div>` : ''}
                ${report.rating ? `<span class="meta-tag" style="background:#e8f5ec;color:#2e7d46;">${report.rating}</span>` : ''}
                <div class="card-content" style="margin-top:8px;">${report.highlights.slice(0, 2).join(' / ')}</div>
                ${stocks.length > 0 ? `<div class="card-tags" style="margin-top:8px;">${stocks.slice(0, 4).map(s => `<span class="mini-tag" onclick="event.stopPropagation();openStockModal('${s.code}')">${s.name}</span>`).join('')}</div>` : ''}
            </div>`;
        }).join('');
    }
    
    function renderTrends() {
        let filtered = trendsData.filter(item => {
            if (activeFilters.search) {
                const searchText = [item.topic, item.broker, item.content, item.companies, item.tags].join(' ').toLowerCase();
                if (!searchText.includes(activeFilters.search)) return false;
            }
            if (activeFilters.tag && !item.tags.includes(activeFilters.tag)) return false;
            if (activeFilters.broker && item.broker !== activeFilters.broker) return false;
            return true;
        });
        
        filtered.sort((a, b) => String(b.date).localeCompare(String(a.date)));
        document.getElementById('filteredCount').textContent = filtered.length;
        const list = document.getElementById('reportsList');
        if (filtered.length === 0) { list.innerHTML = `<div class="empty-state"><div class="icon">ğŸ”</div><p>æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¶¨å‹¢å ±å°</p></div>`; return; }
        
        list.innerHTML = filtered.map(item => {
            const tags = item.tags.split('#').filter(t => t.trim()).slice(0, 3);
            return `<div class="card-base trend-card" onclick="openTrendModal('${item.id}')">
                <span class="trend-badge">ğŸ“ˆ ç”¢æ¥­è¶¨å‹¢</span>
                <div class="card-meta">
                    <span class="meta-tag broker">${item.broker}</span>
                    <span class="meta-tag date">${item.date}</span>
                </div>
                <div class="company-name" style="margin:8px 0;">${item.topic}</div>
                <div style="font-size:12px;color:#5a9e6f;margin-bottom:8px;">ğŸ“Œ ${item.companies}</div>
                <div class="card-content">${item.content.substring(0, 80)}...</div>
                <div class="card-tags" style="margin-top:8px;">${tags.map(t => `<span class="mini-tag">#${t.trim()}</span>`).join('')}</div>
            </div>`;
        }).join('');
    }
    
    function renderStocks() {
        const uniqueStocks = {};
        Object.values(masterStocks).forEach(s => { if (s.code && !uniqueStocks[s.code]) uniqueStocks[s.code] = s; });
        
        let filtered = Object.values(uniqueStocks).filter(s => {
            if (activeFilters.search) {
                const searchText = [s.code, s.name, s.industry, s.subIndustry, s.business].join(' ').toLowerCase();
                if (!searchText.includes(activeFilters.search)) return false;
            }
            if (activeFilters.industry && s.industry !== activeFilters.industry) return false;
            if (activeFilters.market && s.market !== activeFilters.market) return false;
            return true;
        });
        
        filtered.sort((a, b) => a.code.localeCompare(b.code));
        document.getElementById('filteredCount').textContent = filtered.length;
        const list = document.getElementById('reportsList');
        if (filtered.length === 0) { list.innerHTML = `<div class="empty-state"><div class="icon">ğŸ”</div><p>æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å€‹è‚¡</p></div>`; return; }
        
        list.innerHTML = filtered.slice(0, 50).map(s => {
            const concepts = conceptStocks.filter(c => c.code === s.code).slice(0, 3);
            return `<div class="card-base stock-card" onclick="openStockModal('${s.code}')">
                <span class="stock-badge">${s.market}</span>
                <div class="card-header">
                    <div class="card-left">
                        <span class="company-name">${s.name}</span>
                        <span class="stock-code">${s.code}</span>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:16px;font-weight:700;">${s.price}</div>
                        <div style="font-size:11px;color:${String(s.changePercent).includes('-') ? '#d64545' : '#2e7d46'};">${s.change} (${s.changePercent})</div>
                    </div>
                </div>
                <div class="card-meta">
                    <span class="meta-tag industry">${s.industry}</span>
                    <span class="meta-tag date">å¸‚å€¼ ${s.marketCap}å„„</span>
                </div>
                <div class="card-content">${(s.business || '').substring(0, 80)}...</div>
                ${concepts.length > 0 ? `<div class="card-tags" style="margin-top:8px;">${concepts.map(c => `<span class="mini-tag">${c.concept}</span>`).join('')}</div>` : ''}
            </div>`;
        }).join('');
        
        if (filtered.length > 50) {
            list.innerHTML += `<div style="text-align:center;padding:20px;color:#8b8b8b;">é¡¯ç¤ºå‰ 50 ç­†ï¼Œå…± ${filtered.length} ç­†çµæœ</div>`;
        }
    }
    
    function openNewsModal(id) {
        const item = newsData.find(n => n.id == id);
        if (!item) return;
        const content = newsContent[id] || '';
        const tags = item.tags.split('#').filter(t => t.trim());
        
        document.getElementById('modalHeaderInfo').innerHTML = `
            <div class="modal-meta">
                <span class="meta-tag broker">${item.broker}</span>
                <span class="meta-tag date">${item.date}</span>
                <span class="meta-tag category">${item.category}</span>
                <span class="meta-tag" style="background:#fff3e6;color:#c96442;">${item.importance}</span>
            </div>
            <h2 class="modal-title"><span class="company-link" onclick="openStockModal('${item.stockCode}')">${item.company}</span> ${item.stockCode && item.stockCode !== '-' ? `(<span class="company-link" onclick="openStockModal('${item.stockCode}')">${item.stockCode}</span>)` : ''}</h2>`;
        
        document.getElementById('modalBody').innerHTML = `
            <div class="modal-section"><h3 class="section-title">ğŸ“ å®Œæ•´å ±å°å…§å®¹</h3><div class="content-block">${content}</div></div>
            <div class="modal-section"><h3 class="section-title">ğŸ·ï¸ ç›¸é—œæ¨™ç±¤</h3><div class="tags-block">${tags.map(t => `<span class="modal-tag" onclick="searchByTag('${t}');closeModal();">#${t}</span>`).join('')}</div></div>`;
        openModal();
    }
    
    function openMemoModal(id) {
        const item = memoData.find(m => m.id == id);
        if (!item) return;
        const detail = memoDetails[id] || {};
        const finance = memoFinance[item.company] || {};
        const products = memoProducts[item.company] || {};
        const timeline = memoTimeline.filter(t => t.company === item.company);
        const tags = (detail.tags || '').split('#').filter(t => t.trim());
        
        document.getElementById('modalHeaderInfo').innerHTML = `
            <div class="modal-meta">
                <span class="meta-tag broker">${item.broker}</span>
                <span class="meta-tag industry">${item.industry}</span>
                <span class="meta-tag analyst">${item.analyst}</span>
                <span class="meta-tag date">${item.date}</span>
                <span class="meta-tag" style="background:#fff3e6;color:#c96442;">${item.importance}</span>
            </div>
            <h2 class="modal-title"><span class="company-link" onclick="openStockModal('${item.stockCode}')">${item.company}</span> (<span class="company-link" onclick="openStockModal('${item.stockCode}')">${item.stockCode}</span>)</h2>
            <p class="modal-subtitle">${item.type}</p>`;
        
        let html = `<div class="modal-section"><h3 class="section-title">ğŸ“Š è²¡å‹™æ•¸æ“š</h3><div class="info-grid">
            <div class="info-item"><div class="info-label">ç‡Ÿæ”¶YoY</div><div class="info-value">${item.revenueYoY}</div></div>
            <div class="info-item"><div class="info-label">æ¯›åˆ©ç‡</div><div class="info-value">${item.grossMargin}</div></div>
            <div class="info-item"><div class="info-label">EPS</div><div class="info-value">${item.eps}</div></div>
            ${finance.guidance ? `<div class="info-item"><div class="info-label">4Q25æŒ‡å¼•</div><div class="info-value">${finance.guidance}</div></div>` : ''}
        </div></div>`;
        
        if (detail.operation) html += `<div class="modal-section"><h3 class="section-title">ğŸ¯ ç‡Ÿé‹é‡é»</h3><div class="content-block">${detail.operation}</div></div>`;
        if (detail.strategy) html += `<div class="modal-section"><h3 class="section-title">ğŸš€ ç­–ç•¥æ–¹å‘</h3><div class="content-block">${detail.strategy}</div></div>`;
        if (products.products && products.products.length > 0) {
            html += `<div class="modal-section"><h3 class="section-title">ğŸ“¦ ç”¢å“çµæ§‹</h3>${products.products.map(p => `<div class="product-item"><div class="product-name">${p.name}</div><div class="product-ratio">${p.ratio}</div></div>`).join('')}${products.driver ? `<div style="margin-top:10px;font-size:12px;color:#5a9e6f;">ğŸ”¥ é—œéµæˆé•·å‹•èƒ½ï¼š${products.driver}</div>` : ''}</div>`;
        }
        if (detail.qa) html += `<div class="modal-section"><h3 class="section-title">â“ é‡è¦QAæ‘˜è¦</h3><div class="content-block">${detail.qa}</div></div>`;
        if (timeline.length > 0) {
            html += `<div class="modal-section"><h3 class="section-title">ğŸ“… é—œéµæ™‚ç¨‹è¿½è¹¤</h3>${timeline.slice(0, 5).map(t => `<div class="timeline-item"><div class="timeline-date">${t.time} ${t.importance}</div><div class="timeline-event">${t.event}</div><div class="timeline-note">${t.impact} | ${t.status}</div></div>`).join('')}</div>`;
        }
        if (detail.rexView) html += `<div class="modal-section"><h3 class="section-title">ğŸ‘ï¸ Rexè§€å¯Ÿ</h3><div class="content-block">${detail.rexView}</div></div>`;
        if (detail.followUp) html += `<div class="modal-section"><h3 class="section-title">ğŸ“Œ å¾ŒçºŒè¿½è¹¤</h3><div class="content-block">${detail.followUp}</div></div>`;
        if (tags.length > 0) html += `<div class="modal-section"><h3 class="section-title">ğŸ·ï¸ æ¨™ç±¤</h3><div class="tags-block">${tags.map(t => `<span class="modal-tag" onclick="searchByTag('${t}');closeModal();">#${t}</span>`).join('')}</div></div>`;
        
        document.getElementById('modalBody').innerHTML = html;
        openModal();
    }
    
    function openReportModal(id) {
        const report = reportsData.find(r => r.id === id);
        if (!report) return;
        const details = reportDetails[id] || [];
        const stocks = reportStocksData[id] || [];
        
        document.getElementById('modalHeaderInfo').innerHTML = `
            <div class="modal-meta">
                <span class="meta-tag broker">${report.broker}</span>
                <span class="meta-tag industry">${report.industry}</span>
                <span class="meta-tag date">${report.date}</span>
            </div>
            <h2 class="modal-title">${report.title}</h2>
            ${report.subtitle ? `<p class="modal-subtitle">${report.subtitle}</p>` : ''}`;
        
        let html = '';
        if (report.highlights.length > 0) html += `<div class="modal-section"><h3 class="section-title">ğŸ“Œ æ ¸å¿ƒé‡é»</h3><div class="content-block">${report.highlights.map(h => 'â€¢ ' + h).join('\n')}</div></div>`;
        if (details.length > 0) html += `<div class="modal-section"><h3 class="section-title">ğŸ“Š ç„¦é»åˆ†æ</h3>${details.map(d => `<div style="margin-bottom:12px;"><div style="font-weight:600;color:#c96442;margin-bottom:4px;">${d.sectionTitle}</div><div class="content-block">${d.content}</div></div>`).join('')}</div>`;
        if (stocks.length > 0) html += `<div class="modal-section"><h3 class="section-title">ğŸ“ˆ å€‹è‚¡è©•åƒ¹</h3><div class="info-grid">${stocks.map(s => `<div class="info-item" style="cursor:pointer;" onclick="openStockModal('${s.code}')"><div class="info-label">${s.name} (${s.code})</div><div class="info-value">${s.rating} | ç›®æ¨™åƒ¹ ${s.target || '-'}</div></div>`).join('')}</div></div>`;
        
        document.getElementById('modalBody').innerHTML = html;
        openModal();
    }
    
    function openTrendModal(id) {
        const item = trendsData.find(t => t.id == id);
        if (!item) return;
        const tags = item.tags.split('#').filter(t => t.trim());
        
        document.getElementById('modalHeaderInfo').innerHTML = `
            <div class="modal-meta">
                <span class="meta-tag broker">${item.broker}</span>
                <span class="meta-tag date">${item.date}</span>
            </div>
            <h2 class="modal-title">${item.topic}</h2>`;
        
        document.getElementById('modalBody').innerHTML = `
            <div class="modal-section"><h3 class="section-title">ğŸ¢ ç›¸é—œå…¬å¸</h3><div class="tags-block">${item.companies.split('ã€').map(c => `<span class="modal-tag" onclick="searchByCompany('${c.replace(/\([^)]*\)/g, '').trim()}');closeModal();">ğŸ¢ ${c}</span>`).join('')}</div></div>
            <div class="modal-section"><h3 class="section-title">ğŸ“ å®Œæ•´å…§å®¹</h3><div class="content-block">${item.content}</div></div>
            <div class="modal-section"><h3 class="section-title">ğŸ·ï¸ æ¨™ç±¤</h3><div class="tags-block">${tags.map(t => `<span class="modal-tag" onclick="searchByTag('${t}');closeModal();">#${t}</span>`).join('')}</div></div>`;
        openModal();
    }
    
    function openStockModal(codeOrName) {
        const stock = masterStocks[codeOrName] || masterStocks[String(codeOrName)];
        if (!stock) {
            alert(`æ‰¾ä¸åˆ° ${codeOrName} çš„è³‡æ–™`);
            return;
        }
        
        const concepts = conceptStocks.filter(c => c.code === stock.code);
        const relatedNews = newsData.filter(n => n.stockCode === stock.code || n.company === stock.name).slice(0, 3);
        const relatedMemo = memoData.filter(m => m.stockCode === stock.code || m.company === stock.name).slice(0, 3);
        
        document.getElementById('modalHeaderInfo').innerHTML = `
            <div class="modal-meta">
                <span class="meta-tag" style="background:#6b8cce;color:#fff;">${stock.market}</span>
                <span class="meta-tag industry">${stock.industry}</span>
                ${stock.hasFutures ? '<span class="meta-tag" style="background:#9b59b6;color:#fff;">æœ‰æœŸè²¨</span>' : ''}
                ${stock.hasOptions ? '<span class="meta-tag" style="background:#e74c3c;color:#fff;">æœ‰é¸æ“‡æ¬Š</span>' : ''}
            </div>
            <h2 class="modal-title">${stock.name} (${stock.code})</h2>
            <p class="modal-subtitle">${stock.subIndustry}</p>`;
        
        let html = `<div class="modal-section"><h3 class="section-title">ğŸ“Š åŸºæœ¬è³‡æ–™</h3><div class="info-grid">
            <div class="info-item"><div class="info-label">è‚¡åƒ¹</div><div class="info-value" style="font-size:18px;">${stock.price}</div></div>
            <div class="info-item"><div class="info-label">æ¼²è·Œ</div><div class="info-value" style="color:${String(stock.changePercent).includes('-') ? '#d64545' : '#2e7d46'};">${stock.change} (${stock.changePercent})</div></div>
            <div class="info-item"><div class="info-label">æˆäº¤é‡</div><div class="info-value">${stock.volume}å¼µ</div></div>
            <div class="info-item"><div class="info-label">å¸‚å€¼</div><div class="info-value">${stock.marketCap}å„„</div></div>
            <div class="info-item"><div class="info-label">è‚¡æœ¬</div><div class="info-value">${stock.capital}å„„</div></div>
            <div class="info-item"><div class="info-label">é¢å€¼</div><div class="info-value">${stock.parValue}å…ƒ</div></div>
            <div class="info-item"><div class="info-label">æˆç«‹å¹´æ•¸</div><div class="info-value">${stock.foundedYears}å¹´</div></div>
            <div class="info-item"><div class="info-label">æ›ç‰Œå¹´æ•¸</div><div class="info-value">${stock.listedYears}å¹´</div></div>
        </div></div>`;
        
        html += `<div class="modal-section"><h3 class="section-title">ğŸ‘¥ ç¶“ç‡Ÿåœ˜éšŠ</h3><div class="info-grid">
            <div class="info-item"><div class="info-label">è‘£äº‹é•·</div><div class="info-value">${stock.chairman}</div></div>
            <div class="info-item"><div class="info-label">ç¸½ç¶“ç†</div><div class="info-value">${stock.ceo}</div></div>
            ${stock.group ? `<div class="info-item"><div class="info-label">ç›¸é—œé›†åœ˜</div><div class="info-value">${stock.group}</div></div>` : ''}
        </div></div>`;
        
        if (stock.business) html += `<div class="modal-section"><h3 class="section-title">ğŸ’¼ æ¥­å‹™æ‘˜è¦</h3><div class="content-block">${stock.business}</div></div>`;
        
        if (concepts.length > 0) {
            html += `<div class="modal-section"><h3 class="section-title">ğŸ’¡ æ¦‚å¿µè‚¡æ—ç¾¤</h3>
                ${concepts.map(c => `<div class="product-item"><div class="product-name">${c.concept}</div><div class="product-ratio">${c.subRole} - ${c.description}</div><div style="font-size:10px;color:#8b8b8b;margin-top:4px;">${c.importance} | ${c.duration}</div></div>`).join('')}</div>`;
        }
        
        if (relatedNews.length > 0) {
            html += `<div class="modal-section"><h3 class="section-title">ğŸ“° ç›¸é—œå¤–é›»å ±å°</h3>
                ${relatedNews.map(n => `<div class="timeline-item" onclick="closeModal();setTimeout(()=>openNewsModal('${n.id}'),100);" style="cursor:pointer;"><div class="timeline-date">${n.date} | ${n.broker}</div><div class="timeline-event">${n.category}</div></div>`).join('')}</div>`;
        }
        
        if (relatedMemo.length > 0) {
            html += `<div class="modal-section"><h3 class="section-title">ğŸ“‹ ç›¸é—œ Call Memo</h3>
                ${relatedMemo.map(m => `<div class="timeline-item" onclick="closeModal();setTimeout(()=>openMemoModal('${m.id}'),100);" style="cursor:pointer;"><div class="timeline-date">${m.date} | ${m.broker}</div><div class="timeline-event">${m.type}</div></div>`).join('')}</div>`;
        }
        
        html += `<div style="text-align:center;margin-top:20px;padding-top:15px;border-top:1px solid #eceae3;font-size:11px;color:#8b8b8b;">è³‡æ–™æ›´æ–°æ—¥æœŸï¼š${stock.updateDate}</div>`;
        
        document.getElementById('modalBody').innerHTML = html;
        openModal();
    }
    
    function openModal() { document.getElementById('modalOverlay').classList.add('active'); document.body.style.overflow = 'hidden'; }
    function closeModal(e) { if (e && e.target !== document.getElementById('modalOverlay')) return; document.getElementById('modalOverlay').classList.remove('active'); document.body.style.overflow = ''; }
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
</script>
```

</body>
</html>