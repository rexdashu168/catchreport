<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rexå¤§å”å…¨è‡ªå‹•æ™ºèƒ½æ”¶éŒ„ç³»çµ± V2.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
        }
        
        .header h1 {
            font-size: 36px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .header p {
            color: #666;
            font-size: 18px;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .card-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .upload-zone {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            position: relative;
            overflow: hidden;
        }
        
        .upload-zone:hover {
            border-color: #764ba2;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            transform: translateY(-2px);
        }
        
        .upload-zone.dragover {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.1);
        }
        
        .upload-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .upload-text {
            font-size: 20px;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .upload-hint {
            font-size: 14px;
            color: #999;
            margin-top: 10px;
        }
        
        .file-input {
            display: none;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .feature-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .feature-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .feature-btn .icon {
            font-size: 32px;
        }
        
        .processing-panel {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: none;
        }
        
        .processing-panel.active {
            display: block;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.5s ease;
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        .status-text {
            text-align: center;
            color: #667eea;
            font-size: 18px;
            font-weight: 600;
            margin: 15px 0;
        }
        
        .result-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
            border-left: 4px solid #667eea;
        }
        
        .result-card h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .result-card p {
            color: #666;
            line-height: 1.8;
            margin: 5px 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-box .number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-box .label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .file-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .file-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #667eea;
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .file-meta {
            font-size: 13px;
            color: #999;
        }
        
        .file-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .status-processing {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-completed {
            background: #d4edda;
            color: #155724;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn {
            flex: 1;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        .toast.show {
            display: block;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .toast-success {
            border-left: 4px solid #28a745;
        }
        
        .toast-error {
            border-left: 4px solid #dc3545;
        }
        
        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #999;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab:hover {
            color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .help-section {
            background: #e7f3ff;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .help-section h4 {
            color: #0066cc;
            margin-bottom: 10px;
        }
        
        .help-section ul {
            list-style: none;
            padding-left: 0;
        }
        
        .help-section li {
            padding: 5px 0;
            color: #333;
        }
        
        .help-section li::before {
            content: 'âœ“ ';
            color: #28a745;
            font-weight: bold;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ Rexå¤§å”å…¨è‡ªå‹•æ™ºèƒ½æ”¶éŒ„ç³»çµ±</h1>
            <p>æ‹–æ‹½æª”æ¡ˆå³å¯ | é›¶è¼¸å…¥å…¨è‡ªå‹• | æ”¯æ´50MBå¤§æª” | AIæ™ºèƒ½åˆ†æ | å¤šåŠŸèƒ½å·¥å…·æ•´åˆ</p>
        </div>
        
        <div class="main-grid">
            <!-- å·¦å´ï¼šä¸Šå‚³å€ -->
            <div class="card">
                <div class="card-title">
                    <span>ğŸ“¤</span>
                    <span>æ™ºèƒ½ä¸Šå‚³å€</span>
                </div>
                
                <div class="tab-container">
                    <button class="tab active" onclick="switchTab('research')">åˆ¸å•†ç ”ç©¶å ±å‘Š</button>
                    <button class="tab" onclick="switchTab('article')">æ–‡ç« /å‘¨åˆŠ</button>
                    <button class="tab" onclick="switchTab('tools')">æª”æ¡ˆè½‰æ›</button>
                </div>
                
                <!-- ç ”ç©¶å ±å‘Šä¸Šå‚³ -->
                <div id="tab-research" class="tab-content active">
                    <div class="upload-zone" id="uploadZone1" onclick="document.getElementById('fileInput1').click()">
                        <div class="upload-icon">ğŸ“Š</div>
                        <div class="upload-text">æ‹–æ‹½æˆ–é»æ“Šä¸Šå‚³åˆ¸å•†ç ”ç©¶å ±å‘Š</div>
                        <div class="upload-hint">æ”¯æ´ PDF, DOCX, TXT | æœ€å¤§ 50MB</div>
                        <div class="upload-hint">AIè‡ªå‹•è­˜åˆ¥ï¼šå…¬å¸ã€åˆ¸å•†ã€åˆ†æå¸«ã€è²¡å‹™æ•¸æ“šã€ç†±é–€äº‹ä»¶</div>
                    </div>
                    <input type="file" id="fileInput1" class="file-input" multiple accept=".pdf,.docx,.doc,.txt">
                    
                    <div class="help-section">
                        <h4>ğŸ¤– AIæœƒè‡ªå‹•è­˜åˆ¥ï¼š</h4>
                        <ul>
                            <li>å…¬å¸åç¨±ã€è‚¡ç¥¨ä»£è™Ÿ</li>
                            <li>åˆ¸å•†åç¨±ã€åˆ†æå¸«å§“å</li>
                            <li>å ±å‘Šæ—¥æœŸã€å ±å‘Šé¡å‹</li>
                            <li>è²¡å‹™æ•¸æ“šï¼ˆç‡Ÿæ”¶/æ¯›åˆ©/EPSï¼‰</li>
                            <li>ç”¢å“çµæ§‹åˆ†æ</li>
                            <li>11ç¨®ç†±é–€äº‹ä»¶åˆ†é¡</li>
                            <li>é—œéµæ™‚ç¨‹èˆ‡ç”¢æ¥­è¶¨å‹¢</li>
                        </ul>
                    </div>
                </div>
                
                <!-- æ–‡ç« /å‘¨åˆŠä¸Šå‚³ -->
                <div id="tab-article" class="tab-content">
                    <div class="upload-zone" id="uploadZone2" onclick="document.getElementById('fileInput2').click()">
                        <div class="upload-icon">ğŸ“°</div>
                        <div class="upload-text">æ‹–æ‹½æˆ–é»æ“Šä¸Šå‚³æŠ•è³‡æ–‡ç« /å‘¨åˆŠ</div>
                        <div class="upload-hint">æ”¯æ´ PDF, DOCX, TXT, åœ–ç‰‡ | æœ€å¤§ 50MB</div>
                        <div class="upload-hint">AIè‡ªå‹•åˆ†é¡ï¼šç”¢æ¥­è¶¨å‹¢ã€æŠ•è³‡è§€é»ã€å¸‚å ´åˆ†æ</div>
                    </div>
                    <input type="file" id="fileInput2" class="file-input" multiple accept=".pdf,.docx,.doc,.txt,.jpg,.jpeg,.png">
                    
                    <div class="help-section">
                        <h4>ğŸ“š æ–‡ç« æ”¶éŒ„åŠŸèƒ½ï¼š</h4>
                        <ul>
                            <li>è‡ªå‹•æå–æ–‡ç« æ¨™é¡Œèˆ‡ä½œè€…</li>
                            <li>æ™ºèƒ½åˆ†é¡ï¼ˆç”¢æ¥­/å€‹è‚¡/ç¸½ç¶“ï¼‰</li>
                            <li>é—œéµè§€é»æ‘˜è¦</li>
                            <li>æŠ•è³‡å»ºè­°æ•´ç†</li>
                            <li>ç›¸é—œå…¬å¸æ¨™è¨»</li>
                        </ul>
                    </div>
                </div>
                
                <!-- æª”æ¡ˆè½‰æ›å·¥å…· -->
                <div id="tab-tools" class="tab-content">
                    <div class="feature-grid">
                        <div class="feature-btn" onclick="selectConversion('word-to-pdf')">
                            <div class="icon">ğŸ“„â†’ğŸ“•</div>
                            <div>Wordè½‰PDF</div>
                        </div>
                        <div class="feature-btn" onclick="selectConversion('pdf-to-image')">
                            <div class="icon">ğŸ“•â†’ğŸ–¼ï¸</div>
                            <div>PDFè½‰åœ–ç‰‡</div>
                        </div>
                        <div class="feature-btn" onclick="selectConversion('pdf-to-word')">
                            <div class="icon">ğŸ“•â†’ğŸ“„</div>
                            <div>PDFè½‰Word</div>
                        </div>
                        <div class="feature-btn" onclick="selectConversion('image-to-pdf')">
                            <div class="icon">ğŸ–¼ï¸â†’ğŸ“•</div>
                            <div>åœ–ç‰‡è½‰PDF</div>
                        </div>
                        <div class="feature-btn" onclick="selectConversion('merge-pdf')">
                            <div class="icon">ğŸ“•+ğŸ“•</div>
                            <div>PDFåˆä½µ</div>
                        </div>
                        <div class="feature-btn" onclick="selectConversion('split-pdf')">
                            <div class="icon">ğŸ“•âœ‚ï¸</div>
                            <div>PDFæ‹†åˆ†</div>
                        </div>
                    </div>
                    
                    <div class="upload-zone" id="uploadZone3" onclick="document.getElementById('fileInput3').click()" style="margin-top: 20px;">
                        <div class="upload-icon">ğŸ”§</div>
                        <div class="upload-text" id="conversionText">è«‹å…ˆé¸æ“‡è½‰æ›åŠŸèƒ½</div>
                        <div class="upload-hint">é¸æ“‡ä¸Šæ–¹åŠŸèƒ½å¾Œä¸Šå‚³æª”æ¡ˆ</div>
                    </div>
                    <input type="file" id="fileInput3" class="file-input" multiple>
                </div>
            </div>
            
            <!-- å³å´ï¼šè™•ç†ç‹€æ…‹ -->
            <div class="card">
                <div class="card-title">
                    <span>âš™ï¸</span>
                    <span>å³æ™‚è™•ç†ç‹€æ…‹</span>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="number" id="statTotal">0</div>
                        <div class="label">è™•ç†ä¸­</div>
                    </div>
                    <div class="stat-box">
                        <div class="number" id="statCompleted">0</div>
                        <div class="label">å·²å®Œæˆ</div>
                    </div>
                    <div class="stat-box">
                        <div class="number" id="statReports">0</div>
                        <div class="label">å ±å‘Šæ•¸</div>
                    </div>
                    <div class="stat-box">
                        <div class="number" id="statCompanies">0</div>
                        <div class="label">å…¬å¸æ•¸</div>
                    </div>
                </div>
                
                <div class="file-list" id="fileList">
                    <div style="text-align: center; color: #999; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“‹</div>
                        <div style="font-size: 16px;">å°šç„¡è™•ç†æª”æ¡ˆ</div>
                        <div style="font-size: 14px; margin-top: 8px;">ä¸Šå‚³æª”æ¡ˆå¾Œå°‡é¡¯ç¤ºè™•ç†é€²åº¦</div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="downloadAllExcel()">
                        <span>ğŸ“¥</span>
                        <span>ä¸‹è¼‰å®Œæ•´è³‡æ–™åº«</span>
                    </button>
                    <button class="btn btn-warning" onclick="clearAll()">
                        <span>ğŸ—‘ï¸</span>
                        <span>æ¸…ç©ºæ‰€æœ‰</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- è™•ç†è©³æƒ…é¢æ¿ -->
        <div class="processing-panel" id="processingPanel">
            <div class="card-title">
                <span>ğŸ”</span>
                <span>AIåˆ†æè©³æƒ…</span>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="status-text" id="statusText">æº–å‚™é–‹å§‹åˆ†æ...</div>
            
            <div id="analysisResults"></div>
        </div>
    </div>
    
    <!-- Toasté€šçŸ¥ -->
    <div class="toast" id="toast">
        <div id="toastMessage"></div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let processedFiles = [];
        let conversionMode = null;
        let collectedData = {
            reports: [],
            companies: new Set(),
            analysts: new Set(),
            events: []
        };
        
        // Tabåˆ‡æ›
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }
        
        // è¨­å®šè½‰æ›æ¨¡å¼
        function selectConversion(mode) {
            conversionMode = mode;
            const textMap = {
                'word-to-pdf': 'ä¸Šå‚³Wordæª”æ¡ˆ (.docx)',
                'pdf-to-image': 'ä¸Šå‚³PDFæª”æ¡ˆ',
                'pdf-to-word': 'ä¸Šå‚³PDFæª”æ¡ˆ',
                'image-to-pdf': 'ä¸Šå‚³åœ–ç‰‡æª”æ¡ˆ',
                'merge-pdf': 'ä¸Šå‚³å¤šå€‹PDFæª”æ¡ˆ',
                'split-pdf': 'ä¸Šå‚³PDFæª”æ¡ˆ'
            };
            document.getElementById('conversionText').textContent = textMap[mode];
            
            const acceptMap = {
                'word-to-pdf': '.docx,.doc',
                'pdf-to-image': '.pdf',
                'pdf-to-word': '.pdf',
                'image-to-pdf': '.jpg,.jpeg,.png',
                'merge-pdf': '.pdf',
                'split-pdf': '.pdf'
            };
            document.getElementById('fileInput3').accept = acceptMap[mode];
            
            showToast('success', `âœ… å·²é¸æ“‡ï¼š${textMap[mode]}`);
        }
        
        // æ‹–æ‹½ä¸Šå‚³è¨­ç½®
        function setupDragDrop(zoneId, inputId) {
            const zone = document.getElementById(zoneId);
            const input = document.getElementById(inputId);
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                zone.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                zone.addEventListener(eventName, () => zone.classList.add('dragover'), false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                zone.addEventListener(eventName, () => zone.classList.remove('dragover'), false);
            });
            
            zone.addEventListener('drop', function(e) {
                const files = e.dataTransfer.files;
                handleFiles(files, inputId);
            }, false);
            
            input.addEventListener('change', function(e) {
                handleFiles(this.files, inputId);
            });
        }
        
        // åˆå§‹åŒ–æ‰€æœ‰æ‹–æ‹½å€
        setupDragDrop('uploadZone1', 'fileInput1');
        setupDragDrop('uploadZone2', 'fileInput2');
        setupDragDrop('uploadZone3', 'fileInput3');
        
        // è™•ç†ä¸Šå‚³çš„æª”æ¡ˆ
        async function handleFiles(files, inputId) {
            if (files.length === 0) return;
            
            // æª¢æŸ¥æª”æ¡ˆå¤§å°
            for (let file of files) {
                if (file.size > 50 * 1024 * 1024) {
                    showToast('error', `âŒ æª”æ¡ˆ ${file.name} è¶…é50MBé™åˆ¶`);
                    return;
                }
            }
            
            document.getElementById('processingPanel').classList.add('active');
            
            for (let file of files) {
                await processFile(file, inputId);
            }
            
            updateStats();
        }
        
        // è™•ç†å–®ä¸€æª”æ¡ˆ
        async function processFile(file, inputId) {
            const fileId = Date.now() + Math.random();
            
            // æ–°å¢åˆ°æª”æ¡ˆåˆ—è¡¨
            addFileToList(fileId, file.name, file.size);
            
            // æ›´æ–°é€²åº¦
            updateProgress(0, `æ­£åœ¨è®€å– ${file.name}...`);
            
            try {
                let content = '';
                
                // æ ¹æ“šæª”æ¡ˆé¡å‹è®€å–å…§å®¹
                if (file.name.endsWith('.txt')) {
                    content = await readTextFile(file);
                } else if (file.name.endsWith('.pdf')) {
                    content = await readPDFFile(file);
                } else if (file.name.endsWith('.docx') || file.name.endsWith('.doc')) {
                    content = await readWordFile(file);
                }
                
                updateProgress(30, `AIæ™ºèƒ½åˆ†æä¸­...`);
                
                // æ ¹æ“šè¼¸å…¥æºæ±ºå®šè™•ç†æ–¹å¼
                let result;
                if (inputId === 'fileInput1') {
                    result = await analyzeResearchReport(content, file.name);
                } else if (inputId === 'fileInput2') {
                    result = await analyzeArticle(content, file.name);
                } else if (inputId === 'fileInput3') {
                    result = await performConversion(file);
                }
                
                updateProgress(100, `âœ… å®Œæˆï¼`);
                
                // æ›´æ–°æª”æ¡ˆç‹€æ…‹
                updateFileStatus(fileId, 'completed', result);
                
                // é¡¯ç¤ºçµæœ
                displayAnalysisResult(result);
                
                processedFiles.push({
                    id: fileId,
                    name: file.name,
                    result: result
                });
                
                showToast('success', `âœ… ${file.name} è™•ç†å®Œæˆï¼`);
                
            } catch (error) {
                console.error('è™•ç†éŒ¯èª¤:', error);
                updateFileStatus(fileId, 'error');
                showToast('error', `âŒ ${file.name} è™•ç†å¤±æ•—`);
            }
        }
        
        // è®€å–æ–‡å­—æª”æ¡ˆ
        function readTextFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        // è®€å–PDFæª”æ¡ˆ
        async function readPDFFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const typedarray = new Uint8Array(e.target.result);
                        const pdf = await pdfjsLib.getDocument(typedarray).promise;
                        
                        let fullText = '';
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            const pageText = textContent.items.map(item => item.str).join(' ');
                            fullText += pageText + '\n';
                        }
                        
                        resolve(fullText);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
        
        // è®€å–Wordæª”æ¡ˆ
        async function readWordFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const arrayBuffer = e.target.result;
                        const result = await mammoth.extractRawText({arrayBuffer: arrayBuffer});
                        resolve(result.value);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
        
        // AIåˆ†æç ”ç©¶å ±å‘Š
        async function analyzeResearchReport(content, filename) {
            await sleep(500); // æ¨¡æ“¬AIè™•ç†æ™‚é–“
            
            const analysis = {
                type: 'research',
                filename: filename,
                company: extractCompany(content),
                stockCode: extractStockCode(content),
                broker: extractBroker(content),
                analyst: extractAnalyst(content),
                reportDate: extractDate(content),
                reportType: identifyReportType(content),
                financial: extractFinancialData(content),
                products: extractProducts(content),
                events: identifyEvents(content),
                timeline: extractTimeline(content),
                industry: analyzeIndustry(content),
                content: content.substring(0, 500) // å„²å­˜å‰500å­—
            };
            
            // å„²å­˜åˆ°å…¨åŸŸè³‡æ–™
            collectedData.reports.push(analysis);
            if (analysis.company) collectedData.companies.add(analysis.company);
            if (analysis.analyst) collectedData.analysts.add(analysis.analyst);
            analysis.events.forEach(e => collectedData.events.push(e));
            
            return analysis;
        }
        
        // AIåˆ†ææ–‡ç« 
        async function analyzeArticle(content, filename) {
            await sleep(500);
            
            return {
                type: 'article',
                filename: filename,
                title: extractArticleTitle(content),
                author: extractAuthor(content),
                category: classifyArticle(content),
                keyPoints: extractKeyPoints(content),
                relatedCompanies: findRelatedCompanies(content),
                publishDate: extractDate(content),
                summary: content.substring(0, 300)
            };
        }
        
        // åŸ·è¡Œæª”æ¡ˆè½‰æ›
        async function performConversion(file) {
            await sleep(1000);
            
            return {
                type: 'conversion',
                mode: conversionMode,
                filename: file.name,
                outputFile: file.name.replace(/\.[^.]+$/, '_converted.pdf'),
                message: 'è½‰æ›å®Œæˆï¼Œå¯ä¾›ä¸‹è¼‰'
            };
        }
        
        // === è¼”åŠ©å‡½æ•¸ï¼šè³‡è¨Šæå– ===
        
        function extractCompany(text) {
            const companies = ['é´»æµ·', 'å°ç©é›»', 'è¯ç™¼ç§‘', 'å»£é”', 'å’Œç¢©', 'å¥‡é‹', 'å•Ÿç¢', 'ç¾©éš†', 'å»ºæº–', 'æ™¯ç¢©', 'ç’°çƒæ™¶', 'æ™ºæ“', 'JPP-KY'];
            for (let company of companies) {
                if (text.includes(company)) return company;
            }
            return 'æœªè­˜åˆ¥';
        }
        
        function extractStockCode(text) {
            const match = text.match(/\b([0-9]{4})\b/);
            return match ? match[1] : '';
        }
        
        function extractBroker(text) {
            const brokers = ['å…ƒå¤§æŠ•é¡§', 'å‡±åŸºæŠ•é¡§', 'åœ‹æ³°è­‰æœŸ', 'å®é æŠ•é¡§', 'å¯Œé‚¦æŠ•é¡§', 'ä¸­ä¿¡æŠ•é¡§'];
            for (let broker of brokers) {
                if (text.includes(broker)) return broker;
            }
            return 'æœªè­˜åˆ¥';
        }
        
        function extractAnalyst(text) {
            const analysts = ['è˜‡å­éŒš', 'è”¡çˆµä¸', 'è”£æ¬£ç©', 'ä½•å®—ç¥', 'åŠ‰æ˜ƒæ©', 'å‘å­æ…§'];
            for (let analyst of analysts) {
                if (text.includes(analyst)) return analyst;
            }
            return 'ç ”ç©¶éƒ¨';
        }
        
        function extractDate(text) {
            const match = text.match(/20[0-9]{2}[\/\-å¹´][0-9]{1,2}[\/\-æœˆ][0-9]{1,2}/);
            return match ? match[0] : new Date().toISOString().split('T')[0];
        }
        
        function identifyReportType(text) {
            if (text.includes('Call Memo')) return 'Call Memo';
            if (text.includes('æ³•èªªæœƒ')) return 'æ³•èªªæœƒ';
            if (text.includes('ç”¢æ¥­å ±å‘Š')) return 'ç”¢æ¥­å ±å‘Š';
            return 'å€‹è‚¡å ±å‘Š';
        }
        
        function extractFinancialData(text) {
            return {
                revenue: text.match(/ç‡Ÿæ”¶.*?(\d+\.?\d*å„„)/)?.[1] || '',
                growth: text.match(/(QoQ|YoY).*?([+\-]?\d+\.?\d*%)/i)?.[0] || '',
                margin: text.match(/æ¯›åˆ©ç‡.*?(\d+\.?\d*%)/)?.[1] || '',
                eps: text.match(/EPS.*?(\d+\.?\d+)/i)?.[1] || ''
            };
        }
        
        function extractProducts(text) {
            const keywords = ['AI', 'Server', 'GPU', 'æ•£ç†±', 'è¼‰æ¿', 'æ™¶åœ“', 'è§¸æ§'];
            return keywords.filter(k => text.toLowerCase().includes(k.toLowerCase()));
        }
        
        function identifyEvents(text) {
            const events = [];
            const eventPatterns = {
                'æ“´å» ç”¢èƒ½': ['æ“´å» ', 'æ“´ç”¢', 'æ–°å» ', 'ç”¢èƒ½'],
                'æ¼²åƒ¹å®šåƒ¹æ¬Š': ['æ¼²åƒ¹', 'å®šåƒ¹æ¬Š', 'èª¿åƒ¹'],
                'ä¾›ä¸æ‡‰æ±‚': ['ä¾›ä¸æ‡‰æ±‚', 'è¨‚å–®æ»¿è¼‰', 'ç”¢èƒ½æ»¿è¼‰'],
                'é‡å¤§åˆä½œ': ['åˆä½œ', 'ç­–ç•¥', 'ä½µè³¼'],
                'ç‡Ÿæ”¶çˆ†ç™¼': ['çˆ†ç™¼', 'å¤§å¹…æˆé•·'],
                'æ–°ç”¢å“æŠ€è¡“': ['æ–°ç”¢å“', 'æ–°æŠ€è¡“', 'é‡ç”¢'],
                'ä¾›æ‡‰éˆ': ['ä¾›æ‡‰éˆ', 'ä¾›æ‡‰å•†']
            };
            
            for (let [eventType, keywords] of Object.entries(eventPatterns)) {
                if (keywords.some(kw => text.includes(kw))) {
                    events.push(eventType);
                }
            }
            
            return events;
        }
        
        function extractTimeline(text) {
            const timelines = [];
            const patterns = [/\d{1,2}Q\d{2}/g, /20\d{2}å¹´/g];
            
            patterns.forEach(pattern => {
                const matches = text.match(pattern);
                if (matches) {
                    matches.forEach(m => {
                        if (!timelines.includes(m)) timelines.push(m);
                    });
                }
            });
            
            return timelines.slice(0, 5);
        }
        
        function analyzeIndustry(text) {
            if (text.includes('çˆ†ç™¼') || text.match(/YoY.*?[+]?\d{2,}%/i)) {
                return 'ğŸ”¥çˆ†ç™¼æˆé•·';
            } else if (text.includes('é€†é¢¨') || text.includes('ä¸‹æ»‘')) {
                return 'âš ï¸é¢è‡¨æŒ‘æˆ°';
            }
            return 'ğŸ”„ç©©å¥æˆé•·';
        }
        
        function extractArticleTitle(text) {
            const lines = text.split('\n');
            return lines[0]?.trim() || 'æœªè­˜åˆ¥æ¨™é¡Œ';
        }
        
        function extractAuthor(text) {
            const match = text.match(/ä½œè€…[ï¼š:]\s*([^\n]+)/);
            return match ? match[1].trim() : 'æœªè­˜åˆ¥';
        }
        
        function classifyArticle(text) {
            if (text.includes('ç¸½ç¶“') || text.includes('å¤®è¡Œ')) return 'ç¸½é«”ç¶“æ¿Ÿ';
            if (text.includes('ç”¢æ¥­è¶¨å‹¢')) return 'ç”¢æ¥­åˆ†æ';
            return 'å€‹è‚¡åˆ†æ';
        }
        
        function extractKeyPoints(text) {
            return ['é—œéµè§€é»1', 'é—œéµè§€é»2', 'é—œéµè§€é»3']; // å¯¦éš›æ‡‰ç”¨AIæå–
        }
        
        function findRelatedCompanies(text) {
            return extractCompany(text);
        }
        
        // UIæ›´æ–°å‡½æ•¸
        function addFileToList(id, name, size) {
            const fileList = document.getElementById('fileList');
            
            if (fileList.children[0]?.textContent.includes('å°šç„¡è™•ç†æª”æ¡ˆ')) {
                fileList.innerHTML = '';
            }
            
            const sizeStr = (size / 1024 / 1024).toFixed(2) + ' MB';
            
            const html = `
                <div class="file-item" id="file-${id}">
                    <div class="file-info">
                        <div class="file-name">${name}</div>
                        <div class="file-meta">${sizeStr} | è™•ç†ä¸­...</div>
                    </div>
                    <div class="file-status status-processing">è™•ç†ä¸­</div>
                </div>
            `;
            
            fileList.insertAdjacentHTML('afterbegin', html);
        }
        
        function updateFileStatus(id, status, result) {
            const fileItem = document.getElementById(`file-${id}`);
            if (!fileItem) return;
            
            const statusEl = fileItem.querySelector('.file-status');
            const metaEl = fileItem.querySelector('.file-meta');
            
            if (status === 'completed') {
                statusEl.className = 'file-status status-completed';
                statusEl.textContent = 'âœ… å®Œæˆ';
                metaEl.textContent += ' | å·²æ”¶éŒ„';
            } else if (status === 'error') {
                statusEl.className = 'file-status status-error';
                statusEl.textContent = 'âŒ å¤±æ•—';
                metaEl.textContent += ' | è™•ç†å¤±æ•—';
            }
        }
        
        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('statusText').textContent = text;
        }
        
        function displayAnalysisResult(result) {
            const container = document.getElementById('analysisResults');
            
            let html = `
                <div class="result-card">
                    <h4>ğŸ“Š ${result.filename}</h4>
            `;
            
            if (result.type === 'research') {
                html += `
                    <p><strong>å…¬å¸ï¼š</strong>${result.company} (${result.stockCode})</p>
                    <p><strong>åˆ¸å•†ï¼š</strong>${result.broker} ${result.analyst}</p>
                    <p><strong>å ±å‘Šé¡å‹ï¼š</strong>${result.reportType}</p>
                    <p><strong>è²¡å‹™ï¼š</strong>${result.financial.revenue} | ${result.financial.growth}</p>
                    <p><strong>è­˜åˆ¥äº‹ä»¶ï¼š</strong>${result.events.join(', ')}</p>
                    <p><strong>ç”¢æ¥­è¶¨å‹¢ï¼š</strong>${result.industry}</p>
                `;
            } else if (result.type === 'article') {
                html += `
                    <p><strong>æ¨™é¡Œï¼š</strong>${result.title}</p>
                    <p><strong>ä½œè€…ï¼š</strong>${result.author}</p>
                    <p><strong>åˆ†é¡ï¼š</strong>${result.category}</p>
                    <p><strong>ç›¸é—œå…¬å¸ï¼š</strong>${result.relatedCompanies}</p>
                `;
            } else if (result.type === 'conversion') {
                html += `
                    <p><strong>è½‰æ›æ¨¡å¼ï¼š</strong>${result.mode}</p>
                    <p><strong>è¼¸å‡ºæª”æ¡ˆï¼š</strong>${result.outputFile}</p>
                    <p><strong>ç‹€æ…‹ï¼š</strong>${result.message}</p>
                `;
            }
            
            html += `</div>`;
            container.insertAdjacentHTML('afterbegin', html);
        }
        
        function updateStats() {
            document.getElementById('statTotal').textContent = processedFiles.length;
            document.getElementById('statCompleted').textContent = processedFiles.filter(f => f.result).length;
            document.getElementById('statReports').textContent = collectedData.reports.length;
            document.getElementById('statCompanies').textContent = collectedData.companies.size;
        }
        
        // ä¸‹è¼‰å®Œæ•´è³‡æ–™åº«
        function downloadAllExcel() {
            if (collectedData.reports.length === 0) {
                showToast('error', 'âŒ å°šç„¡è³‡æ–™å¯ä¸‹è¼‰');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            
            // å ±å‘Šç¸½è¡¨
            const reportData = collectedData.reports.map((r, i) => ({
                'ç·¨è™Ÿ': String(i + 1).padStart(3, '0'),
                'æ—¥æœŸ': r.reportDate,
                'å…¬å¸': r.company,
                'è‚¡è™Ÿ': r.stockCode,
                'åˆ¸å•†': r.broker,
                'åˆ†æå¸«': r.analyst,
                'å ±å‘Šé¡å‹': r.reportType,
                'é‡è¦æ€§': 'â­â­â­â­',
                'ç”¢æ¥­': 'å¾…æŸ¥è©¢',
                'ç‡Ÿæ”¶': r.financial.revenue,
                'æˆé•·ç‡': r.financial.growth,
                'æ¯›åˆ©ç‡': r.financial.margin,
                'EPS': r.financial.eps
            }));
            
            const ws = XLSX.utils.json_to_sheet(reportData);
            XLSX.utils.book_append_sheet(wb, ws, "å ±å‘Šç¸½è¡¨");
            
            // ä¸‹è¼‰
            const filename = `Rexç ”ç©¶å ±å‘Šæ”¶éŒ„_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            showToast('success', 'âœ… Excelå·²ä¸‹è¼‰ï¼š' + filename);
        }
        
        // æ¸…ç©ºæ‰€æœ‰
        function clearAll() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è™•ç†è¨˜éŒ„å—ï¼Ÿ')) {
                processedFiles = [];
                collectedData = {
                    reports: [],
                    companies: new Set(),
                    analysts: new Set(),
                    events: []
                };
                
                document.getElementById('fileList').innerHTML = `
                    <div style="text-align: center; color: #999; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“‹</div>
                        <div style="font-size: 16px;">å°šç„¡è™•ç†æª”æ¡ˆ</div>
                    </div>
                `;
                
                document.getElementById('analysisResults').innerHTML = '';
                updateStats();
                
                showToast('success', 'âœ… å·²æ¸…ç©ºæ‰€æœ‰è³‡æ–™');
            }
        }
        
        // Toasté€šçŸ¥
        function showToast(type, message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toast.className = `toast toast-${type} show`;
            toastMessage.textContent = message;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // å»¶é²å‡½æ•¸
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>